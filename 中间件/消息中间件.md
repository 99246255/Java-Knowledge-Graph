#消息中间件
 
 
 1. 为什么在你们系统架构中要引入消息中间件
   系统解耦， 异步调用， 流量削峰
        复杂系统的解耦
        复杂链路的异步调用
        瞬时高峰的削峰处理
 2. 引入消息中间件有什么缺点
 
 系统可用性降低
 系统稳定性降低
 分布式一致性问题
 

3 : 意外宕机，问题凸现
那你说说如果仓储服务作为消费者服务，刚收到了一个订单消息，但是在完成消息的处理之前，也就是还没对订单完成仓储调度发货，结果这个仓储服务突然就宕机了，这个时候会发生什么事情？
需要等任务执行完再发生处理完消息ack，某些MQ有自动ack需要调成手动ack
RabbitMQ这个中间件默认的一个行为，就是只要仓储服务收到一个订单消息，RabbitMQ就会立马把这条订单消息给标记为删除，这个行为叫做自动ack，也就是投递完成一条消息就自动确认这个消息处理完毕了。此时需要手动发送ack消息给RabbitMQ。
 
    自动ack机制
    delivery tag机制 :保证投递消息不丢失的 confirm 机制
    ack批量与异步提交机制
    消息重发机制
    手动nack触发消息重发机制
    prefetch count过大导致内存溢出问题
    prefetch count过小导致吞吐量过低

 消息的持久化
 需要queue的信息持久化,发送的消息持久化
 RabbitMQ的消息持久化，是不承诺100%的消息不丢失的。
 因为有可能RabbitMQ接收到了消息，但是还没来得及持久化到磁盘，他自己就宕机了，这个时候消息还是会丢失的。
 
 ## 如何保证
      消息高可靠传递（0丢失）
      消息幂等性传递（绝对不重复）
      百万消息积压的线上故障处理
      
      
 高并发下如何保证投递消息不丢失：
 问题
 1消息写入存储，需要等待ack
 2不能同步写
 
 方案：
 1:kv数据库
 异步回调：收到ack，从kv删除这条临时消息，超过时间没收到重发消息